name: Build DD-WRT K2P

on:
  workflow_dispatch:
    inputs:
      revision:
        description: 'SVN Revision (leave default for latest)'
        required: true
        默认: 'HEAD'
      ssh:
        description: 'SSH connection for debugging (optional)'
        required: false
        默认: 'false'

jobs:
  build:
    runs-on: ubuntu-22.04
    env:
      # 避免编译过程中的交互提示
      DEBIAN_FRONTEND: noninteractive
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Install Dependencies
        run: |
          sudo apt-get update
          # 安装编译 DD-WRT 所需的依赖，特别是 python2 和旧版工具
          sudo apt-get install -y \
            unzip libtool-bin ccache curl cmake gperf gawk flex bison nano xxd \
            fakeroot kmod cpio bc zip git python3-docutils gettext gengetopt gtk-doc-tools \
            autoconf-archive automake autopoint meson texinfo build-essential help2man pkg-config \
            zlib1g-dev libgmp3-dev libmpc-dev libmpfr-dev libncurses5-dev libltdl-dev wget libc-dev-bin \
            subversion python2
          
          # 设置 Python2 为默认 python (许多旧脚本依赖 'python' 命令)
          sudo update-alternatives --install /usr/bin/python python /usr/bin/python2 1

      - name: Download Toolchain
        run: |
          # 下载对应的 MIPSEL 工具链
          wget https://github.com/tsl0922/DD-WRT/releases/download/toolchain/toolchain-mipsel_24kc_gcc-13.1.0_musl.tar.gz
          tar zxf toolchain-mipsel_24kc_gcc-13.1.0_musl.tar.gz
          # 确保工具链路径正确 (Makefile 中定义的是 TOP_DIR 下)
          ls -l toolchain-mipsel_24kc_gcc-13.1.0_musl/bin/

      - name: Checkout Source Code
        run: |
          # 生成配置文件
          echo "PROFILE=k2p" > .config
          
          # 修改 Makefile 允许非交互式 SVN
          sed -i 's/svn co/svn co --trust-server-cert --non-interactive/g' Makefile
          sed -i 's/svn up/svn up --trust-server-cert --non-interactive/g' Makefile
          
          # 拉取源码
          make checkout REVISION=${{ github.event.inputs.revision }}

      - name: Fix Source Code & LAN Bug
        run: |
          echo "=== 1. 修复编译脚本依赖问题 ==="
          # 修复 mk-ca-bundle 脚本中的 curl 调用
          find . -name "mk-ca-bundle.pl" -exec sed -i 's/my \$opt_k = 0;/my \$opt_k = 1;/g' {} +
          find . -name "mk-ca-bundle.pl" -exec sed -i 's/\$curl -s -L/\$curl -k -s -L/g' {} +
          
          # 删除冲突的 libpcap 生成文件 (解决 scanner.c/gencode.c 重复定义报错)
          find . -name "gencode.c" -type f -delete
          find . -name "scanner.c" -type f -delete
          
          # 移除 Makefile 中的 -Werror (将警告视为错误)，防止因为小警告导致编译停止
          find . -name "Makefile" -exec sed -i 's/-Werror//g' {} +

          echo "=== 2. 预处理 (应用补丁) ==="
          # 先运行 make prepare 让项目自带的补丁生效
          make prepare

          echo "=== 3. 修复 K2P LAN 口不通问题 (VLAN Fix) ==="
          # 定位 defaults.c 文件
          DEFAULTS_FILE="dd-wrt/src/router/services/sysinit/defaults.c"
          
          if [ -f "$DEFAULTS_FILE" ]; then
            echo "Found defaults.c, applying K2P LAN fix..."
            
            # 策略：MT7621 通常 CPU 端口是 6t 而不是 5t。
            # 很多旧代码把 K2P 误写为 "1 2 3 4 5t" 或者 "0 1 2 3 5t"
            # 下面的命令将全局替换常见的错误配置为 K2P 的正确配置
            
            # 1. 修正 VLAN1 (LAN) 端口定义: 0 1 2 3 6t
            sed -i 's/vlan1ports="0 1 2 3 5t"/vlan1ports="0 1 2 3 6t"/g' $DEFAULTS_FILE
            sed -i 's/vlan1ports="1 2 3 4 5t"/vlan1ports="0 1 2 3 6t"/g' $DEFAULTS_FILE
            
            # 2. 修正 VLAN2 (WAN) 端口定义: 4 6t
            sed -i 's/vlan2ports="4 5t"/vlan2ports="4 6t"/g' $DEFAULTS_FILE
            sed -i 's/vlan2ports="0 5t"/vlan2ports="4 6t"/g' $DEFAULTS_FILE
            
            # 3. 强制 K2P 特定逻辑 (如果在 defaults.c 中有专门针对 K2P 的判断)
            # 我们在文件末尾添加一段调试日志，证明修改已生效
            echo "// Patch applied by GitHub Actions" >> $DEFAULTS_FILE
            
            echo "VLAN Fix Applied. Checking grep output:"
            grep -C 2 "vlan1ports" $DEFAULTS_FILE | head -n 20 || true
          else
            echo "Error: Could not find $DEFAULTS_FILE to patch!"
            exit 1
          fi

      - name: Configure and Build
        run: |
          echo "Starting Configure..."
          make configure
          
          echo "Starting Build..."
          make all

      - name: Organize Artifacts
        run: |
          mkdir -p firmware
          find images -name "*.bin" -exec cp {} firmware/ \;
          ls -lh firmware/

      - name: Upload Firmware
        uses: actions/upload-artifact@v4
        with:
          name: DD-WRT-K2P-Firmware
          path: firmware/
      
      # SSH 调试步骤，只有在手动启动时选择了 ssh=true 才会运行
      # 如果编译失败，可以在这一步进入服务器手动查看错误日志
      - name: SSH connection to Actions
        uses: P3TERX/ssh2actions@v1.0.0
        if: (github.event.inputs.ssh == 'true') || contains(github.event.action, 'ssh')
        env:
         TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
         TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}

