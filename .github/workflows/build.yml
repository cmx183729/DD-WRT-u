name: Build DD-WRT K2P (Rewrite Makefile)

on:
  workflow_dispatch:
    inputs:
      revision:
        description: 'SVN Revision (Default: HEAD)'
        required: true
        default: 'HEAD'
      ssh:
        description: 'SSH Debug'
        required: false
        default: 'false'

jobs:
  build:
    runs-on: ubuntu-22.04
    env:
      DEBIAN_FRONTEND: noninteractive
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            unzip libtool-bin ccache curl cmake gperf gawk flex bison nano xxd \
            fakeroot kmod cpio bc zip git python3-docutils gettext gengetopt gtk-doc-tools \
            autoconf-archive automake autopoint meson texinfo build-essential help2man pkg-config \
            zlib1g-dev libgmp3-dev libmpc-dev libmpfr-dev libncurses5-dev libltdl-dev wget libc-dev-bin \
            subversion python2 dos2unix
          
          sudo update-alternatives --install /usr/bin/python python /usr/bin/python2 1

      - name: Download Toolchain
        run: |
          echo "Downloading toolchain..."
          wget -q https://github.com/tsl0922/DD-WRT/releases/download/toolchain/toolchain-mipsel_24kc_gcc-13.1.0_musl.tar.gz
          tar zxf toolchain-mipsel_24kc_gcc-13.1.0_musl.tar.gz
          ls -d toolchain-*

      - name: Nuke and Rewrite Makefile
        run: |
          echo "Detected broken Makefile. Overwriting with correct content..."
          rm -f Makefile
          
          # 写入全新的 Makefile (使用 Tab 缩进)
          cat <<'EOF' > Makefile
          TOP_DIR:=$(CURDIR)

          SVN := svn
          SRC_DIR := $(TOP_DIR)/dd-wrt
          SRC_URL := svn://svn.dd-wrt.com/DD-WRT
          REVISION := HEAD

          BUILD_DIR := $(SRC_DIR)/src/router
          LINUX_DIR := $(SRC_DIR)/src/linux/universal/linux-4.14
          TOOLCHAIN_DIR := $(TOP_DIR)/toolchain-mipsel_24kc_gcc-13.1.0_musl

          define DefineProfile
            BOARD=$(1)
            DTS=$(2)
            CONFIG=$(3)
            KCONFIG=$(4)
          endef

          ifneq ($(wildcard .config),)
            include .config
          endif

          ifeq ($(PROFILE),k2p-mt76)
            $(eval $(call DefineProfile,k2p,K2P-mt76,mt76.config,mt76.config))
          else ifeq ($(PROFILE),k2p)
            $(eval $(call DefineProfile,k2p,K2P,.config,.config))
          else ifeq ($(PROFILE),k2p-mini)
            $(eval $(call DefineProfile,k2p,K2P,mini.config,.config))
          else ifeq ($(PROFILE),msg1500)
            $(eval $(call DefineProfile,msg1500,MSG1500,.config,.config))
          else
            # Default to K2P if profile not found
            $(eval $(call DefineProfile,k2p,K2P,.config,.config))
          endif

          MAKE_ROUTER := $(MAKE) -C $(BUILD_DIR) -f Makefile.mt7621 BOARD=$(BOARD) DTS=$(DTS) RPROFILE=$(PROFILE)
          PATH := $(TOOLCHAIN_DIR)/bin:$(TOP_DIR)/tools:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
          KERNEL := universal/linux-4.14
          CRDA_URL := git://git.kernel.org/pub/scm/linux/kernel/git/sforshee/wireless-regdb.git

          export PATH SVN

          define PatchDir
          	@if [ -d $(1) ] && [ "$$(ls $(1) | wc -l)" -gt 0 ]; then \
          		for p in $(1)/*.patch; do \
          			echo "== Applying $$p..."; \
          			for f in $$(grep '^Index: ' $$p | awk '{print $$2}'); do \
          				svn revert $(SRC_DIR)/$$f; \
          			done; \
          			patch -t -d $(SRC_DIR) -p0 < $$p || true; \
          		done \
          	fi
          endef

          all:
          	$(MAKE_ROUTER) kernel
          	$(MAKE_ROUTER) all
          	$(MAKE_ROUTER) install
          	$(MAKE_ROUTER) image
          	mkdir -p images && cp $(BUILD_DIR)/mipsel-uclibc/dd-wrt-v3.0-*.bin images

          checkout:
          	-[ -d "$(SRC_DIR)" ] && svn cleanup $(SRC_DIR)
          	$(SVN) co $(SRC_URL) -r $(REVISION) $(SRC_DIR) --depth immediates --quiet --trust-server-cert --non-interactive
          	@for d1 in $$($(SVN) ls $(SRC_DIR) | grep '/$$'); do \
          		[ "$$d1" = "ar5315_microredboot/" -o "$$d1" = "redboot/" ] && continue; \
          		echo "== Updating $$d1"; \
          		$(SVN) up -r $(REVISION) $(SRC_DIR)/$$d1 --set-depth immediates --quiet --trust-server-cert --non-interactive; \
          		for d2 in $$($(SVN) ls $(SRC_DIR)/$$d1 | grep '/$$'); do \
          			echo "== Updating $$d1$$d2"; \
          			if [ "$$d1$$d2" = "src/linux/" ]; then \
          				$(SVN) up -r $(REVISION) $(SRC_DIR)/$$d1$$d2 --set-depth immediates --quiet --trust-server-cert --non-interactive; \
          			else \
          				$(SVN) up -r $(REVISION) $(SRC_DIR)/$$d1$$d2 --set-depth infinity --quiet --trust-server-cert --non-interactive; \
          			fi; \
          		done; \
          	done
          	$(SVN) up -r $(REVISION) $(SRC_DIR)/src/linux/$(KERNEL) --set-depth infinity --quiet --trust-server-cert --non-interactive
          	cp $(TOP_DIR)/files/router/Makefile.mt7621 $(BUILD_DIR)/Makefile.mt7621
          	cp $(TOP_DIR)/configs/$(BOARD)/$(subst mini,,$(CONFIG)) $(BUILD_DIR)/.config

          prepare:
          	$(call PatchDir,$(TOP_DIR)/patches)
          	$(call PatchDir,$(TOP_DIR)/patches/$(BOARD))
          	$(call PatchDir,$(TOP_DIR)/patches/drv)
          	rm -rf $(LINUX_DIR)/drivers/net/ethernet/raeth
          	rm -rf $(LINUX_DIR)/net/nat/foe_hook
          	cp -r $(TOP_DIR)/files/linux/drivers $(LINUX_DIR)/
          	cp -r $(TOP_DIR)/files/linux/include $(LINUX_DIR)/
          	cp -r $(TOP_DIR)/files/linux/net $(LINUX_DIR)/
          	cp -r $(TOP_DIR)/files/router/* $(BUILD_DIR)/
          	cp $(TOP_DIR)/configs/$(BOARD)/dts/$(DTS).dts $(LINUX_DIR)/dts/$(DTS).dts
          	cp $(TOP_DIR)/configs/$(BOARD)/kernel/$(KCONFIG) $(LINUX_DIR)/.config
          	cp $(TOP_DIR)/configs/$(BOARD)/$(CONFIG) $(BUILD_DIR)/.config
          	ln -sf ../../opt $(BUILD_DIR)/opt
          	cp $(LINUX_DIR)/drivers/net/wireless/Kconfig.dir882 $(LINUX_DIR)/drivers/net/wireless/Kconfig
          	$(MAKE_ROUTER) gen_revision

          configure:
          	$(MAKE_ROUTER) ncurses-configure ncurses
          	$(MAKE_ROUTER) zlib-configure zlib
          	$(MAKE_ROUTER) libffi-configure libffi
          	$(MAKE_ROUTER) libnl-configure libnl
          	$(MAKE_ROUTER) libpcap-configure libpcap
          	$(MAKE_ROUTER) libucontext-configure libucontext
          	$(MAKE_ROUTER) openssl-configure openssl
          	$(MAKE_ROUTER) libevent-configure libevent
          	$(MAKE_ROUTER) curl-configure curl
          	$(MAKE_ROUTER) gmp-configure gmp
          	$(MAKE_ROUTER) wolfssl-configure wolfssl
          	$(MAKE_ROUTER) pcre-configure pcre
          	$(MAKE_ROUTER) nettle-configure nettle
          	$(MAKE_ROUTER) configure
          
          gen_patches:
          	echo "Skipping gen_patches in CI"

          %:
          	$(MAKE_ROUTER) $*
          EOF
          
          # 将生成的 Makefile 中的空格缩进强制转换为 Tab (以防复制粘贴时 Tab 丢失)
          sed -i 's/^[ ]\+/\t/g' Makefile
          # 确保前面几行变量定义没有缩进 (Fix Makefile:7 error)
          sed -i '1,20s/^\t//g' Makefile
          
      - name: Checkout Source Code
        run: |
          echo "PROFILE=k2p" > .config
          echo "Checking out SVN revision: ${{ github.event.inputs.revision }}..."
          # 使用新生成的 Makefile 进行 checkout
          make checkout REVISION=${{ github.event.inputs.revision }}

      - name: Fix Source Code & LAN Bug
        run: |
          echo "=== 1. Prepare Patches ==="
          make prepare

          echo "=== 2. Fix Compile Errors ==="
          # 修复 mk-ca-bundle 脚本
          find . -name "mk-ca-bundle.pl" -exec sed -i 's/my \$opt_k = 0;/my \$opt_k = 1;/g' {} +
          find . -name "mk-ca-bundle.pl" -exec sed -i 's/\$curl -s -L/\$curl -k -s -L/g' {} +
          
          # 删除冲突文件
          find . -name "gencode.c" -type f -delete
          find . -name "scanner.c" -type f -delete
          
          # 移除 -Werror
          find . -name "Makefile" -exec sed -i 's/-Werror//g' {} +

          echo "=== 3. Fix K2P LAN/VLAN ==="
          DEFAULTS_FILE=$(find dd-wrt -name "defaults.c" | grep "services/sysinit")
          
          if [ -f "$DEFAULTS_FILE" ]; then
            echo "Applying MT7621 VLAN Fix to $DEFAULTS_FILE..."
            # 强制修正 K2P 的 VLAN 端口 (CPU Port 6t)
            sed -i 's/vlan1ports="0 1 2 3 5t"/vlan1ports="0 1 2 3 6t"/g' "$DEFAULTS_FILE"
            sed -i 's/vlan1ports="1 2 3 4 5t"/vlan1ports="0 1 2 3 6t"/g' "$DEFAULTS_FILE"
            sed -i 's/vlan2ports="4 5t"/vlan2ports="4 6t"/g' "$DEFAULTS_FILE"
            sed -i 's/vlan2ports="0 5t"/vlan2ports="4 6t"/g' "$DEFAULTS_FILE"
            
            grep -C 2 "vlan1ports" "$DEFAULTS_FILE" | head -n 10
          else
            echo "Error: defaults.c not found! Skipping patch, but build might have LAN bugs."
          fi

      - name: Configure and Build
        run: |
          make configure
          make all

      - name: Organize Artifacts
        run: |
          mkdir -p firmware
          find images -name "*.bin" -exec cp {} firmware/ \;
          ls -lh firmware/

      - name: Upload Firmware
        uses: actions/upload-artifact@v4
        with:
          name: DD-WRT-K2P-Firmware
          path: firmware/
      
      - name: SSH connection to Actions
        uses: P3TERX/ssh2actions@v1.0.0
        if: (github.event.inputs.ssh == 'true') || contains(github.event.action, 'ssh')
        env:
         TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
         TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
